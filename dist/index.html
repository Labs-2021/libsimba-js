<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>libsimba-js</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
              integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <a class="navbar-brand" href="#">libSimba-js</a>
        </nav>
        <div class="container-fluid">
            <div class="row">
                <nav class="col-md-2 d-none d-md-block bg-light sidebar">
                    <div class="sidebar-sticky">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a id="unlockWallet" class="nav-link active" href="#">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                    Unlock Wallet
                                </a>
                            </li>
                            <li class="nav-item">
                                <a id="generateWallet" class="nav-link active" href="#">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                    Generate Wallet
                                </a>
                            </li>
                            <li class="nav-item">
                                <a id="importWallet" class="nav-link active" href="#">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                    Import Wallet
                                </a>
                            </li>
                            <li class="nav-item">
                                <a id="deleteWallet" class="nav-link active" href="#">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                    Delete Wallet
                                </a>
                            </li>
                            <li class="nav-item">
                                <a id="callMethod" class="nav-link active" href="#">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                                    Call Method
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>

                <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4"><div class="chartjs-size-monitor" style="position: absolute; left: 0px; top: 0px; right: 0px; bottom: 0px; overflow: hidden; pointer-events: none; visibility: hidden; z-index: -1;"><div class="chartjs-size-monitor-expand" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;"><div style="position:absolute;width:1000000px;height:1000000px;left:0;top:0"></div></div><div class="chartjs-size-monitor-shrink" style="position:absolute;left:0;top:0;right:0;bottom:0;overflow:hidden;pointer-events:none;visibility:hidden;z-index:-1;"><div style="position:absolute;width:200%;height:200%;left:0; top:0"></div></div></div>
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 id="address" class="h2"></h1>
    <!--                    <div class="btn-toolbar mb-2 mb-md-0">-->
    <!--                        <div class="btn-group mr-2">-->
    <!--                            <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>-->
    <!--                            <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>-->
    <!--                        </div>-->
    <!--                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">-->
    <!--                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>-->
    <!--                            This week-->
    <!--                        </button>-->
    <!--                    </div>-->
                    </div>


                    <h2 id="progressTitle"></h2>
                    <div id="progressBar" class="progress">
                        <div id="progressBar_El" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>

<!--                    <canvas class="my-4 w-100 chartjs-render-monitor" id="myChart" width="1312" height="553" style="display: block; width: 1050px; height: 443px;"></canvas>-->

                    <h2>Logs</h2>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead>
                            <tr>
                                <th>Time</th>
                                <th>Message</th>
                            </tr>
                            </thead>
                            <tbody id="tblBody">

                            </tbody>
                        </table>
                    </div>
                </main>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="signingPermissionModal" tabindex="-1" role="dialog" aria-labelledby="signingPermissionModalTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="signingPermissionModalTitle">Wallet</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        Do you wish to sign the transaction?
                    </div>
                    <div class="modal-footer">
                        <button id="signingPermissionModalNo" type="button" class="btn btn-secondary" data-dismiss="modal">No</button>
                        <button id="signingPermissionModalYes" type="button" class="btn btn-primary">Yes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="externalFaucetModal" tabindex="-1" role="dialog" aria-labelledby="externalFaucetModalTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="externalFaucetModalTitle">Faucet</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        This blockchain requires you to visit an external site to add funds (this is not under our control, please excersize caution).
                        <a id="faucetLink" href="">Click here to visit the faucet.</a>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
                integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
                crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
                integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
                crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
                integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
                crossorigin="anonymous"></script>
        <script type="text/javascript">
            document.addEventListener("DOMContentLoaded", async () => {
                //A little helper function that outputs any calls to console.log to the table on the page.
                (function(){
                    var _log = console.log;
                    var _error = console.error;

                    console.log = function(logMessage){
                        // Do something with the log message
                        let tblBody = document.getElementById('tblBody');
                        let tr = document.createElement('tr');
                        let time = document.createElement('td');
                        let message = document.createElement('td');

                        time.innerText = new Date();
                        message.innerText = logMessage;

                        tr.appendChild(time);
                        tr.appendChild(message);

                        tblBody.appendChild(tr);
                        _log.apply(console,arguments);
                    };

                    console.error = function(logMessage){
                        // Do something with the log message
                        let tblBody = document.getElementById('tblBody');
                        let tr = document.createElement('tr');
                        let time = document.createElement('td');
                        let message = document.createElement('td');

                        time.innerText = new Date();
                        message.innerText = logMessage;

                        tr.appendChild(time);
                        tr.appendChild(message);

                        tr.className += " table-danger";

                        tblBody.appendChild(tr);
                        _error.apply(console,arguments);
                    };
                })();

                let progressTitle = document.getElementById('progressTitle');
                let progressBar = document.getElementById('progressBar');
                let progressBar_El = document.getElementById('progressBar_El');
                progressTitle.hidden = true;
                progressBar.hidden = true;

                document.getElementById('callMethod').hidden = true;
                document.getElementById('generateWallet').hidden = true;
                document.getElementById('importWallet').hidden = true;
                document.getElementById('unlockWallet').hidden = true;

                //Create a new wallet instance
                let wallet = new libsimba.LocalWallet(
                    () => {
                        return new Promise((resolve, reject)=>{
                            // let signingPermissionModal = document.getElementById('signingPermissionModal');
                            document.getElementById('signingPermissionModalNo').addEventListener('click',()=>{
                                $('#signingPermissionModal').modal('hide');
                                resolve(false);
                            });
                            document.getElementById('signingPermissionModalYes').addEventListener('click',()=>{
                                $('#signingPermissionModal').modal('hide');
                                resolve(true);
                            });

                            $('#signingPermissionModal').modal();
                        });
                    }
                );

                const walletLoaded = async ()=>{
                    //Print out the wallet address, you don't need to do this, but useful to see
                    let address = await wallet.getAddress();
                    document.getElementById('address').innerText = `Eth Address: ${address}`;
                    console.log(`Eth Address: ${address}`);
                    document.getElementById('callMethod').hidden = false;
                    document.getElementById('generateWallet').hidden = true;
                    document.getElementById('importWallet').hidden = true;
                    document.getElementById('unlockWallet').hidden = true;
                    document.getElementById('deleteWallet').hidden = true;
                };

                document.getElementById('generateWallet').addEventListener('click', async ()=>{
                    //There is no local wallet, lets create one
                    console.log("Creating Wallet");

                    progressTitle.hidden = false;
                    progressTitle.innerText = 'Creating Wallet';
                    progressBar.hidden = false;
                    progressBar_El.setAttribute('aria-valuenow', '0');

                    await wallet.generateWallet(
                        'test1234',
                        (progress) => {
                            progressBar_El.setAttribute('aria-valuenow', (progress*100)+'');
                            progressBar_El.style.width = (progress*100)+'%';
                        });
                    await walletLoaded();
                });

                document.getElementById('unlockWallet').addEventListener('click', async ()=>{
                    //There is a local wallet, unlock it
                    console.log("Unlocking Wallet");

                    progressTitle.hidden = false;
                    progressTitle.innerText = 'Creating Wallet';
                    progressBar.hidden = false;
                    progressBar_El.setAttribute('aria-valuenow', '0');

                    await wallet.unlockWallet(
                        'test1234',
                        (progress) => {
                            progressBar_El.setAttribute('aria-valuenow', (progress*100)+'');
                            progressBar_El.style.width = (progress*100)+'%';
                        }
                    );
                    await walletLoaded();
                });

                document.getElementById('importWallet').addEventListener('click', async ()=>{

                    progressTitle.hidden = false;
                    progressTitle.innerText = 'Creating Wallet';
                    progressBar.hidden = false;
                    progressBar_El.setAttribute('aria-valuenow', '0');

                    // We can also generate a wallet from a private key, or from a mnemonic
                    await wallet.generateWalletFromPrivateKey(
                        'cf0811297a0e539128025b8558df2b434e9425bd93886e5d43dfd14f9da44c14',
                        'test1234',
                        (progress)=>{
                            progressBar_El.setAttribute('aria-valuenow', (progress*100)+'');
                            progressBar_El.style.width = (progress*100)+'%';
                        });
                    await walletLoaded();
                });

                document.getElementById('deleteWallet').addEventListener('click', async ()=>{
                    wallet.deleteWallet();

                    document.getElementById('generateWallet').hidden = false;
                    document.getElementById('importWallet').hidden = false;
                    document.getElementById('unlockWallet').hidden = true;
                    document.getElementById('callMethod').hidden = true;
                });

                //Check if there's an existing local wallet
                if(wallet.walletExists()){
                    document.getElementById('generateWallet').hidden = true;
                    document.getElementById('importWallet').hidden = true;
                    document.getElementById('unlockWallet').hidden = false;
                }else{
                    document.getElementById('generateWallet').hidden = false;
                    document.getElementById('importWallet').hidden = false;
                    document.getElementById('unlockWallet').hidden = true;
                }

                document.getElementById('callMethod').addEventListener('click', async ()=>{
                    console.log("Creating Simbachain instance");
                    let simba = await libsimba.getSimbaInstance(
                        'https://api.simbachain.com/v1/libSimba-SimbaChat-Quorum/',
                        wallet,
                        '04d1729f7144873851a745d2ae85639f55c8e3de5aea626a2bcd0055c01ba6fc');

                    console.log("Fetching balance");
                    let balance = await simba.getBalance();
                    console.log(`Balance: ${balance.amount} ${balance.currency}`);

                    console.log("Attempting to add funds to balance");
                    try{
                        let result = await simba.addFunds();
                        if (result.poa) {
                            console.log("Didn't add funds: PoA network.", result);
                        } else if (result.faucet_url) {
                            console.log("Didn't add funds: External faucet: " + result.faucet_url, result);
                            console.log("To top up, you need to ask the user to visit the url in `faucet_url`");
                            document.getElementById('faucetLink').setAttribute('href', result.faucet_url);
                            $('#externalFaucetModal').modal();
                        } else {
                            console.log('Funded - May take up to a minute for the transaction to process: ', result);
                        }
                    }catch (e) {
                        console.error("Error while adding funds: " + e.message, e);
                    }

                    //These are the parameters to pass to the method call
                    let methodParams = {
                        assetId: "0xbad65ff688a28efdd17d979c12f0ab2e2de305dbc8a2aa6be45ed644da822cfb",
                        name: "A Test Room",
                        createdBy: "Kieran"
                    };

                    console.log('Calling createRoom method');
                    //Call the `createRoom` method, with the above params. The txn is signed with the wallet we created/loaded above
                    simba.callMethod('createRoom', methodParams)
                        .then((ret) => {
                            console.log("Method called Successfully!", ret);
                            console.log("Waiting for confirmation of deployment to blockchain...");
                            //The request and signing were successful, now we wait for the API to
                            // tell us if the txn was successful or not.
                            const {future, cancel} = simba.waitForSuccessOrError(ret);

                            //`future` is a JS Promise that will resolve when we know the status
                            //`cancel` is a function, you can call it to cancel the above request if needed
                            future
                                .then(txn => {
                                    //txn will hold the txn details
                                    //txn.status will hold the status
                                    console.log("Deployment Status: " + txn.status, txn);
                                })
                                .catch((error) => {
                                    console.error("Failured to deploy method call transaction: " + error.message, error);
                                })
                        })
                        .catch((error) => {
                            console.error("Failured to call method : " + error.message, error);
                        });
                });

            });
        </script>
    <script src="libsimba.js"></script></body>
</html>
